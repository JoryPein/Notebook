<!DOCTYPE html>
<html lang="zh-CN" id="html-root">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤‡å¿˜å½•</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FBBF24">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        #folder-list li, #note-list li { transition: background-color 0.2s ease-in-out; }
        #search-input::-webkit-search-cancel-button { -webkit-appearance: none; }
        #editor { height: 100%; }
        .tag-pill { transition: background-color 0.2s; }
        .tag-remove-btn { opacity: 0; transition: opacity 0.2s; }
        .tag-pill:hover .tag-remove-btn { opacity: 1; }
        #confirmation-modal > div { transition: transform 0.2s ease-out; }

        /* â˜… æ–°å¢ï¼šToast é€šçŸ¥çš„åŠ¨ç”»å’Œæ ·å¼ */
        .toast {
            animation: toast-in 0.3s ease-out forwards, toast-out 0.3s 2.7s ease-in forwards;
            transform: translateX(100%);
        }
        .toast.error { background-color: #EF4444; color: white; }
        .toast.success { background-color: #10B981; color: white; }
        @keyframes toast-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes toast-out {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* â˜… æ–°å¢ï¼šç”¨äºè§†è§‰éšè—ä½†å¯¹å±å¹•é˜…è¯»å™¨å¯è§çš„ç±» */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* â˜… æ”¹è¿›ï¼šä¸ºé”®ç›˜ç”¨æˆ·æä¾›æ›´æ¸…æ™°çš„ç„¦ç‚¹æŒ‡ç¤º */
        :focus-visible {
            outline: 2px solid #FBBF24 !important;
            outline-offset: 2px !important;
            border-radius: 4px !important;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans text-gray-800 dark:text-gray-200">

    <div class="flex h-screen">
        <!-- ä¾§è¾¹æ  -->
        <aside id="sidebar" class="w-full md:w-80 bg-gray-50 dark:bg-gray-800 flex flex-col absolute md:static z-20 -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out h-full border-r border-gray-200 dark:border-gray-700">
            <!-- å¤´éƒ¨ -->
            <div class="px-4 pt-5 pb-2 flex justify-between items-center">
                <h1 class="text-2xl font-bold dark:text-white">å¤‡å¿˜å½•</h1>
                <button id="new-note-btn" title="æ–°å»ºå¤‡å¿˜å½•" aria-label="æ–°å»ºå¤‡å¿˜å½•" class="text-yellow-500 hover:text-yellow-600 dark:hover:text-yellow-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                </button>
            </div>

            <!-- æœç´¢æ¡† -->
            <div class="px-4 py-2">
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                    </span>
                    <input id="search-input" type="search" placeholder="æœç´¢å†…å®¹å’Œæ ‡ç­¾" class="w-full pl-10 pr-4 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 dark:focus:ring-yellow-500 bg-white dark:bg-gray-700 dark:text-gray-200">
                </div>
            </div>
            
            <!-- æ–‡ä»¶å¤¹åˆ—è¡¨ -->
            <div class="px-4 pt-2 border-t border-gray-200 dark:border-gray-700">
                <h2 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">æ–‡ä»¶å¤¹</h2>
                <ul id="folder-list" class="overflow-y-auto"></ul>
            </div>
            
            <!-- å¤‡å¿˜å½•åˆ—è¡¨ -->
            <div class="flex-grow flex flex-col min-h-0 border-t border-gray-200 dark:border-gray-700 mt-4">
                <h2 id="notes-header" class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2 px-4 pt-4">å¤‡å¿˜å½•</h2>
                 <ul id="note-list" class="overflow-y-auto flex-grow"></ul>
            </div>

            <!-- åº•éƒ¨æ“ä½œ -->
            <div class="p-2 border-t border-gray-200 dark:border-gray-700 grid grid-cols-2 gap-2">
                <button id="new-folder-btn" class="w-full text-left text-sm p-2 rounded-md text-yellow-600 dark:text-yellow-400 hover:bg-yellow-100 dark:hover:bg-gray-700 flex items-center">
                    <span class="text-lg mr-1">+</span> æ–°å»ºæ–‡ä»¶å¤¹
                </button>
                <button id="theme-toggle-btn" class="w-full text-sm p-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center justify-center">
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    <span id="theme-text">åˆ‡æ¢ä¸»é¢˜</span>
                </button>
                <button id="export-all-btn" class="w-full text-left text-sm p-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    å¯¼å‡ºå¤‡ä»½
                </button>
                <button id="import-zip-btn" class="w-full text-left text-sm p-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                    å¯¼å…¥å¤‡ä»½
                </button>
                <input type="file" id="import-file-input" class="hidden" accept=".zip">
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒºåŸŸ (ç¼–è¾‘å™¨) -->
        <main class="flex-1 flex flex-col w-full bg-white dark:bg-gray-800 md:bg-gray-100 md:dark:bg-gray-900">
            <header class="p-2 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-white dark:bg-gray-800 md:bg-transparent md:dark:bg-transparent">
                <button id="menu-toggle-btn" aria-label="åˆ‡æ¢ä¾§è¾¹æ " aria-expanded="false" class="p-2 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white md:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <div id="auto-save-status" class="text-sm text-gray-400 dark:text-gray-500 transition-opacity duration-300 opacity-0"></div>
                <div class="flex-grow"></div>
                <select id="note-folder-selector" class="hidden mr-4 text-sm bg-gray-200 dark:bg-gray-700 border-none rounded-md p-2 focus:ring-2 focus:ring-yellow-400 dark:focus:ring-yellow-500 outline-none"></select>
                <button id="delete-note-btn" title="åˆ é™¤å¤‡å¿˜å½•" aria-label="åˆ é™¤å¤‡å¿˜å½•" class="p-2 text-red-500 hover:text-red-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            </header>
            
            <div id="tags-area" class="hidden p-2 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 flex items-center flex-wrap gap-2">
                <div id="tags-container" class="flex items-center flex-wrap gap-2"></div>
                <input id="tag-input" type="text" placeholder="æ·»åŠ æ ‡ç­¾..." class="bg-transparent text-sm p-1 focus:outline-none flex-grow min-w-[100px]">
            </div>
            
            <div id="editor-placeholder" class="flex-grow p-5 text-lg text-gray-400 dark:text-gray-500 flex items-center justify-center">
                <span>é€‰æ‹©ä¸€ä¸ªå¤‡å¿˜å½•æˆ–åˆ›å»ºä¸€ä¸ªæ–°çš„</span>
            </div>
            <div id="editor" class="flex-grow w-full hidden"></div>
        </main>
    </div>

    <!-- å³é”®èœå• -->
    <div id="note-context-menu" class="hidden absolute z-30 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-md shadow-lg py-1">
        <button data-action="delete" class="w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-gray-600 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            åˆ é™¤å¤‡å¿˜å½•
        </button>
    </div>
    
    <!-- ç¡®è®¤åˆ é™¤å¼¹çª— (Modal) -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm p-6" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <h3 id="modal-title" class="text-lg font-bold text-gray-900 dark:text-white">ç¡®è®¤åˆ é™¤</h3>
            <div class="mt-2">
                <p class="text-sm text-gray-600 dark:text-gray-300">
                    æ‚¨ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ä¸ªå¤‡å¿˜å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚
                </p>
            </div>
            <div class="mt-5 sm:mt-6 flex justify-end space-x-3">
                <button type="button" id="modal-cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                    å–æ¶ˆ
                </button>
                <button type="button" id="modal-confirm-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    ç¡®è®¤åˆ é™¤
                </button>
            </div>
        </div>
    </div>

    <!-- â˜… æ–°å¢ï¼šç”¨äºæ“ä½œåé¦ˆçš„ Toast é€šçŸ¥å®¹å™¨ -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-2"></div>

    <!-- â˜… æ–°å¢ï¼šä¸ºå±å¹•é˜…è¯»å™¨å‡†å¤‡çš„åŠ¨æ€å®£å‘ŠåŒºåŸŸ (è§†è§‰ä¸Šéšè—) -->
    <div id="announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const noteList = document.getElementById('note-list');
            const editorContainer = document.getElementById('editor');
            const editorPlaceholder = document.getElementById('editor-placeholder');
            const newNoteBtn = document.getElementById('new-note-btn');
            const deleteNoteBtn = document.getElementById('delete-note-btn');
            const htmlRoot = document.getElementById('html-root');
            const noteFolderSelector = document.getElementById('note-folder-selector');
            const folderList = document.getElementById('folder-list');
            const newFolderBtn = document.getElementById('new-folder-btn');
            const searchInput = document.getElementById('search-input');
            const sidebar = document.getElementById('sidebar');
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const notesHeader = document.getElementById('notes-header');
            const noteContextMenu = document.getElementById('note-context-menu');
            const exportAllBtn = document.getElementById('export-all-btn');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const themeIconLight = document.getElementById('theme-icon-light');
            const themeIconDark = document.getElementById('theme-icon-dark');
            const importZipBtn = document.getElementById('import-zip-btn');
            const importFileInput = document.getElementById('import-file-input');
            const tagsArea = document.getElementById('tags-area');
            const tagsContainer = document.getElementById('tags-container');
            const tagInput = document.getElementById('tag-input');
            const confirmationModal = document.getElementById('confirmation-modal');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            let modalConfirmBtn = document.getElementById('modal-confirm-btn');

            // â˜… æ–°å¢ï¼šè·å–æ–°æ·»åŠ çš„å…ƒç´ 
            const toastContainer = document.getElementById('toast-container');
            const announcer = document.getElementById('announcer');
            const autoSaveStatus = document.getElementById('auto-save-status');
            
            let db;
            let activeNoteId = null;
            let activeFolderId = 'all'; 
            let currentSearchQuery = '';
            let debounceTimeout;
            let updateTimeout;
            let editor;
            let lastFocusedElement; // â˜… æ–°å¢ï¼šç”¨äºç„¦ç‚¹ç®¡ç†

            // --- â˜… æ–°å¢è¾…åŠ©å‡½æ•° ---
            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type} py-2 px-4 rounded-md shadow-lg`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            function announce(message) {
                announcer.textContent = message;
                setTimeout(() => { announcer.textContent = ''; }, 100);
            }
            
            function updateSaveStatus(status) {
                if (!autoSaveStatus) return;
                if (status === 'saving') {
                    autoSaveStatus.textContent = 'æ­£åœ¨ä¿å­˜...';
                    autoSaveStatus.classList.remove('opacity-0');
                } else if (status === 'saved') {
                    autoSaveStatus.textContent = 'å·²ä¿å­˜ âœ“';
                    setTimeout(() => autoSaveStatus.classList.add('opacity-0'), 2000);
                } else {
                    autoSaveStatus.classList.add('opacity-0');
                }
            }

            // --- æ•°æ®åº“åˆå§‹åŒ– ---
            const request = indexedDB.open('NotesAppDB_v6', 1);
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('folders')) { db.createObjectStore('folders', { keyPath: 'id', autoIncrement: true }); }
                if (!db.objectStoreNames.contains('notes')) {
                    const notesStore = db.createObjectStore('notes', { keyPath: 'id', autoIncrement: true });
                    notesStore.createIndex('folderId_idx', 'folderId', { unique: false });
                }
            };
            request.onsuccess = (e) => { db = e.target.result; initTheme(); renderUI(); };
            request.onerror = (e) => console.error('æ•°æ®åº“é”™è¯¯:', e.target.errorCode);

            // --- â˜… æ ¸å¿ƒå‡½æ•° (å·²ä¿®æ”¹) ---
            async function renderUI() { await populateFolderSelector(); await displayFolders(); await displayNotes(); updateActiveStates(); };

            async function displayFolders() {
                if (!db) return;
                const allFolders = await getAllFromStore('folders');
                const allNotes = await getAllFromStore('notes');
                const noteCounts = allNotes.reduce((acc, note) => {
                    const folderId = note.folderId;
                    if(folderId) acc[folderId] = (acc[folderId] || 0) + 1;
                    return acc;
                }, {});

                folderList.innerHTML = `<li data-folder-id="all" tabindex="0" class="p-2 rounded-md cursor-pointer hover:bg-yellow-100 dark:hover:bg-gray-700 flex justify-between items-center"><span class="font-semibold">æ‰€æœ‰å¤‡å¿˜å½•</span><span class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded-full">${allNotes.length}</span></li>`;
                
                if (allFolders.length === 0 && allNotes.length === 0) {
                     folderList.innerHTML += `<li class="p-2 text-sm text-gray-400">è¿˜æ²¡æœ‰æ–‡ä»¶å¤¹ã€‚</li>`;
                } else {
                    allFolders.sort((a,b) => a.name.localeCompare(b.name, 'zh-CN')).forEach(folder => {
                        const count = noteCounts[folder.id] || 0;
                        const listItem = document.createElement('li');
                        listItem.dataset.folderId = folder.id;
                        listItem.tabIndex = 0;
                        listItem.className = "p-2 rounded-md cursor-pointer hover:bg-yellow-100 dark:hover:bg-gray-700 flex justify-between items-center group";
                        listItem.innerHTML = `<span>${folder.name}</span> <div class="flex items-center"><span class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded-full mr-2">${count}</span><button title="åˆ é™¤æ–‡ä»¶å¤¹" aria-label="åˆ é™¤æ–‡ä»¶å¤¹ ${folder.name}" class="delete-folder-btn hidden group-hover:block text-red-500 text-xs">ğŸ—‘ï¸</button></div>`;
                        folderList.appendChild(listItem);
                    });
                }
            }

            async function displayNotes() {
                if (!db) return; 
                let notes; 
                const allFolders = await getAllFromStore('folders'); 
                const folderMap = new Map(allFolders.map(f => [f.id, f.name])); 
                if (currentSearchQuery) { 
                    notesHeader.textContent = `æœç´¢ç»“æœ`; 
                    const allNotes = await getAllFromStore('notes'); 
                    const query = currentSearchQuery.toLowerCase(); 
                    notes = allNotes.filter(note => { const contentMatch = note.content.toLowerCase().includes(query); const tagsMatch = note.tags && note.tags.some(tag => tag.toLowerCase().includes(query)); return contentMatch || tagsMatch; }); 
                } else { 
                    if (activeFolderId === 'all') { 
                        notes = await getAllFromStore('notes'); 
                        notesHeader.textContent = "æ‰€æœ‰å¤‡å¿˜å½•"; 
                    } else { 
                        notes = await getAllFromIndex('notes', 'folderId_idx', IDBKeyRange.only(activeFolderId)); 
                        const folder = folderMap.get(activeFolderId); 
                        notesHeader.textContent = folder ? folder : "å¤‡å¿˜å½•"; 
                    } 
                } 
                notes.sort((a, b) => b.timestamp - a.timestamp); 
                noteList.innerHTML = '';
                if (notes.length === 0) {
                    let emptyMessage = 'è¿™é‡Œè¿˜æ²¡æœ‰å¤‡å¿˜å½•ã€‚';
                    if (currentSearchQuery) emptyMessage = `æ²¡æœ‰æ‰¾åˆ°â€œ${currentSearchQuery}â€çš„ç»“æœã€‚`;
                    else if (activeFolderId !== 'all') emptyMessage = 'è¿™ä¸ªæ–‡ä»¶å¤¹æ˜¯ç©ºçš„ã€‚';
                    noteList.innerHTML = `<li class="p-4 text-center text-gray-400">${emptyMessage}</li>`;
                } else {
                    notes.forEach(note => { const listItem = createNoteListItem(note, currentSearchQuery ? folderMap.get(note.folderId) : null); noteList.appendChild(listItem); });
                }
            };

            async function updateNoteContent() {
                if (activeNoteId === null) return;
                updateSaveStatus('saving');
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(async () => {
                    const t = db.transaction(['notes'], 'readwrite'); 
                    const store = t.objectStore('notes'); 
                    const existingNote = await dbRequest(store, 'get', activeNoteId); 
                    if (existingNote) { 
                        const updatedNote = { ...existingNote, content: editor.getMarkdown(), timestamp: Date.now() }; 
                        store.put(updatedNote); 
                        await t.done; 
                        updateSaveStatus('saved');
                        await displayNotes(); 
                        updateActiveStates(); 
                    }
                }, 300);
            }
            
            async function selectNote(id) { 
                const note = await getById('notes', id); 
                if (note) { 
                    activeNoteId = id; 
                    if(!editor) recreateEditor(localStorage.theme || 'default');
                    editor.setMarkdown(note.content || ''); 
                    editorContainer.classList.remove('hidden'); 
                    editorPlaceholder.style.display = 'none'; 
                    deleteNoteBtn.style.display = 'block'; 
                    noteFolderSelector.classList.remove('hidden'); 
                    tagsArea.classList.remove('hidden'); 
                    noteFolderSelector.value = note.folderId === null ? 'null' : note.folderId; 
                    renderTagsUI(note.tags || []); 
                    updateSaveStatus('clear');
                    if (currentSearchQuery) { 
                        activeFolderId = note.folderId || 'all'; 
                    } 
                    await renderUI(); 
                    const noteEl = noteList.querySelector(`[data-note-id="${id}"] h2`);
                    if (noteEl) announce(`å·²æ‰“å¼€å¤‡å¿˜å½•ï¼š${noteEl.textContent}`);
                } 
                if (window.innerWidth < 768) sidebar.classList.add('-translate-x-full'); 
            };
            
            async function selectFolder(id) { 
                activeFolderId = id; 
                activeNoteId = null; 
                currentSearchQuery = ''; 
                searchInput.value = '';
                editorContainer.classList.add('hidden'); 
                editorPlaceholder.style.display = 'flex'; 
                deleteNoteBtn.style.display = 'none'; 
                noteFolderSelector.classList.add('hidden'); 
                tagsArea.classList.add('hidden');
                updateSaveStatus('clear');
                await renderUI(); 
                const folderEl = folderList.querySelector(`[data-folder-id="${id}"] span`);
                if (folderEl) announce(`å·²é€‰æ‹©æ–‡ä»¶å¤¹ï¼š${folderEl.textContent}`);
            };

            function handleDeleteNote(noteIdToDelete) {
                if (noteIdToDelete === null) return;
                lastFocusedElement = document.activeElement;
                confirmationModal.dataset.noteId = noteIdToDelete;
                confirmationModal.classList.remove('hidden');
                setTimeout(() => confirmationModal.querySelector('div').style.transform = 'scale(1)', 10);
                const newConfirmBtn = modalConfirmBtn.cloneNode(true);
                modalConfirmBtn.parentNode.replaceChild(newConfirmBtn, modalConfirmBtn);
                modalConfirmBtn = newConfirmBtn;
                setTimeout(() => modalCancelBtn.focus(), 100);
                modalConfirmBtn.addEventListener('click', async () => {
                    const noteId = parseInt(confirmationModal.dataset.noteId);
                    const t = db.transaction(['notes'], 'readwrite');
                    try {
                        await dbRequest(t.objectStore('notes'), 'delete', noteId);
                        if (activeNoteId === noteId) {
                            activeNoteId = null;
                            editorContainer.classList.add('hidden');
                            editorPlaceholder.style.display = 'flex';
                            deleteNoteBtn.style.display = 'none';
                            noteFolderSelector.classList.add('hidden');
                            tagsArea.classList.add('hidden');
                        }
                        await renderUI();
                        showToast('å¤‡å¿˜å½•å·²åˆ é™¤', 'success');
                        announce('å¤‡å¿˜å½•å·²åˆ é™¤');
                    } catch (err) {
                        console.error("åˆ é™¤å¤±è´¥:", err);
                        showToast('åˆ é™¤å¤±è´¥', 'error');
                    } finally {
                        hideModal();
                    }
                }, { once: true });
            }
            
            function hideModal() {
                const modalContent = confirmationModal.querySelector('div');
                modalContent.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    confirmationModal.classList.add('hidden');
                    modalContent.style.transform = '';
                    if (lastFocusedElement) lastFocusedElement.focus();
                }, 200);
            }
            
            function updateActiveStates() { 
                document.querySelectorAll('#folder-list li').forEach(li => { 
                    const isActive = !currentSearchQuery && li.dataset.folderId == activeFolderId; 
                    li.classList.toggle('bg-yellow-200', isActive); 
                    li.classList.toggle('dark:bg-yellow-800', isActive); 
                    isActive ? li.setAttribute('aria-current', 'true') : li.removeAttribute('aria-current');
                }); 
                document.querySelectorAll('#note-list li').forEach(li => { 
                    const isActive = li.dataset.noteId == activeNoteId; 
                    li.classList.toggle('bg-yellow-200', isActive); 
                    li.classList.toggle('dark:bg-yellow-800', isActive); 
                    isActive ? li.setAttribute('aria-current', 'true') : li.removeAttribute('aria-current');
                }); 
            };

            async function exportAllNotesAsZip() { 
                const originalBtnContent = exportAllBtn.innerHTML; 
                exportAllBtn.disabled = true; 
                exportAllBtn.innerHTML = 'æ­£åœ¨å¯¼å‡º...'; 
                try { 
                    const notes = await getAllFromStore('notes'); 
                    if (notes.length === 0) { 
                        showToast('æ²¡æœ‰å¤‡å¿˜å½•å¯å¯¼å‡ºã€‚', 'error');
                        return; 
                    } 
                    const folders = await getAllFromStore('folders'); 
                    const folderMap = new Map(folders.map(f => [f.id, f.name])); 
                    const zip = new JSZip(); 
                    for (const note of notes) { 
                        const folderName = folderMap.get(note.folderId) || 'æœªåˆ†ç±»'; 
                        let fileName = (note.content.split('\n')[0] || 'æ— æ ‡é¢˜ç¬”è®°').replace(/^[#\s]+/, '').replace(/[\\/:\*\?"<>\|]/g, '_').trim(); 
                        if (!fileName) fileName = 'æ— æ ‡é¢˜ç¬”è®°'; 
                        let fullPath = `${folderName}/${fileName}.md`; 
                        let counter = 1; 
                        while(zip.file(fullPath)) { fullPath = `${folderName}/${fileName} (${counter++}).md`; } 
                        zip.file(fullPath, note.content); 
                    } 
                    const blob = await zip.generateAsync({ type: 'blob' }); 
                    const link = document.createElement('a'); 
                    link.href = URL.createObjectURL(blob); 
                    link.download = `å¤‡å¿˜å½•å¤‡ä»½_${new Date().toISOString().slice(0,10)}.zip`; 
                    document.body.appendChild(link); 
                    link.click(); 
                    document.body.removeChild(link); 
                    URL.revokeObjectURL(link.href);
                    showToast('å¯¼å‡ºæˆåŠŸï¼', 'success');
                } catch (error) { 
                    console.error('å¯¼å‡ºå¤±è´¥:', error); 
                    showToast('å¯¼å‡ºè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ã€‚', 'error');
                } finally { 
                    exportAllBtn.disabled = false; 
                    exportAllBtn.innerHTML = originalBtnContent; 
                } 
            };
            
            // --- å…¶ä»–æœªå˜å‡½æ•° (ä¿æŒåŸæ ·) ---
            function createNoteListItem(note, folderName = null) { const [title, ...rest] = note.content.split('\n'); const contentPreview = rest.join(' ').trim().replace(/<[^>]*>?/gm, '') || 'æ²¡æœ‰é¢å¤–å†…å®¹'; const listItem = document.createElement('li'); listItem.dataset.noteId = note.id; listItem.tabIndex = 0; listItem.className = `p-4 border-b border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-yellow-100 dark:hover:bg-gray-700`; let folderInfo = folderName ? `<span class="text-xs text-yellow-700 bg-yellow-200 px-1.5 py-0.5 rounded-full">${folderName}</span>` : ''; listItem.innerHTML = `<h2 class="font-bold text-gray-800 dark:text-gray-100 truncate">${title || 'æ–°å¤‡å¿˜å½•'}</h2><div class="flex justify-between items-center mt-1"><p class="text-sm text-gray-500 dark:text-gray-400 truncate flex-grow">${contentPreview}</p>${folderInfo}</div>`; return listItem; };
            function renderTagsUI(tags = []) { tagsContainer.innerHTML = ''; tags.forEach(tag => { const tagEl = document.createElement('span'); tagEl.className = 'tag-pill bg-yellow-200 dark:bg-yellow-700 text-yellow-800 dark:text-yellow-100 text-xs font-semibold px-2.5 py-1 rounded-full flex items-center'; tagEl.innerHTML = `<span>${tag}</span><button data-tag-name="${tag}" class="tag-remove-btn ml-1.5 text-yellow-600 dark:text-yellow-300 hover:text-yellow-800 dark:hover:text-yellow-100" aria-label="ç§»é™¤æ ‡ç­¾ ${tag}">&times;</button>`; tagsContainer.appendChild(tagEl); }); };
            async function populateFolderSelector() { if (!db) return; const allFolders = await getAllFromStore('folders'); noteFolderSelector.innerHTML = `<option value="null">æœªåˆ†ç±»</option>`; allFolders.sort((a,b) => a.name.localeCompare(b.name, 'zh-CN')).forEach(folder => { noteFolderSelector.innerHTML += `<option value="${folder.id}">${folder.name}</option>`; }); };
            function dbRequest(store, method, ...args) { return new Promise((res, rej) => { const req = store[method](...args); req.onsuccess = () => res(req.result); req.onerror = (e) => rej(e.target.error); }); }
            function getAllFromStore(storeName) { return new Promise((res, rej) => { const t = db.transaction([storeName], 'readonly'); dbRequest(t.objectStore(storeName), 'getAll').then(res, rej); }); }
            function getAllFromIndex(storeName, indexName, query) { return new Promise((res, rej) => { const t = db.transaction([storeName], 'readonly'); const i = t.objectStore(storeName).index(indexName); dbRequest(i, 'getAll', query).then(res, rej); }); }
            function getById(storeName, id) { return new Promise((res, rej) => { const t = db.transaction([storeName], 'readonly'); dbRequest(t.objectStore(storeName), 'get', id).then(res, rej); }); }
            function countInIndex(storeName, indexName, query) { return new Promise((res, rej) => { const t = db.transaction([storeName], 'readonly'); const i = t.objectStore(storeName).index(indexName); dbRequest(i, 'count', query).then(res, rej); }); }
            async function createNote() { const noteFolderId = (activeFolderId === 'all' || currentSearchQuery) ? null : activeFolderId; const newNote = { content: '# æ–°å¤‡å¿˜å½•\n\n', timestamp: Date.now(), folderId: noteFolderId, tags: [] }; const t = db.transaction(['notes'], 'readwrite'); const newId = await dbRequest(t.objectStore('notes'), 'add', newNote); await t.done; if (currentSearchQuery) { searchInput.value = ''; currentSearchQuery = ''; } await selectNote(newId); editor.focus(); };
            async function updateNoteTags(newTags) { if (activeNoteId === null) return; const t = db.transaction(['notes'], 'readwrite'); const store = t.objectStore('notes'); const note = await dbRequest(store, 'get', activeNoteId); if(note) { note.tags = newTags; store.put(note); } await t.done; };
            async function createFolder() { const folderName = prompt("è¯·è¾“å…¥æ–°æ–‡ä»¶å¤¹çš„åç§°ï¼š"); if (folderName?.trim()) { const t = db.transaction(['folders'], 'readwrite'); await dbRequest(t.objectStore('folders'), 'add', { name: folderName.trim() }); await t.done; await renderUI(); } };
            async function deleteFolder(folderId) { const noteCount = await countInIndex('notes', 'folderId_idx', IDBKeyRange.only(folderId)); if (noteCount > 0) { alert('æ–‡ä»¶å¤¹ä¸ä¸ºç©ºï¼Œæ— æ³•åˆ é™¤ã€‚'); return; } if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç©ºæ–‡ä»¶å¤¹å—ï¼Ÿ')) { const t = db.transaction(['folders'], 'readwrite'); await dbRequest(t.objectStore('folders'), 'delete', folderId); await t.done; if(activeFolderId === folderId) await selectFolder('all'); else await renderUI(); } };
            async function moveNoteToFolder() { if (activeNoteId === null) return; const newFolderId = noteFolderSelector.value === 'null' ? null : parseInt(noteFolderSelector.value); const t = db.transaction(['notes'], 'readwrite'); const store = t.objectStore('notes'); const note = await dbRequest(store, 'get', activeNoteId); if (note && note.folderId !== newFolderId) { note.folderId = newFolderId; store.put(note); await t.done; await renderUI(); } };
            async function importNotesFromZip(file) { if (!file) return; const originalBtn = importZipBtn.innerHTML; importZipBtn.disabled = true; importZipBtn.innerHTML = 'æ­£åœ¨å¯¼å…¥...'; try { const zip = await JSZip.loadAsync(file); const allFolders = await getAllFromStore('folders'); let folderMap = new Map(allFolders.map(f => [f.name, f.id])); const notePromises = []; zip.forEach((relativePath, zipEntry) => { if (!zipEntry.dir && relativePath.endsWith('.md') && !relativePath.startsWith('__MACOSX')) { const noteContentPromise = async () => { const content = await zipEntry.async('string'); const pathParts = relativePath.split('/'); let folderId = null; if (pathParts.length > 1) { const folderName = pathParts[0]; if(folderName !== 'æœªåˆ†ç±»'){ if (!folderMap.has(folderName)) { const tFolder = db.transaction(['folders'], 'readwrite'); const newFolderId = await dbRequest(tFolder.objectStore('folders'), 'add', { name: folderName }); await tFolder.done; folderMap.set(folderName, newFolderId); folderId = newFolderId; } else { folderId = folderMap.get(folderName); } } } const newNote = { content: content, timestamp: Date.now(), folderId: folderId, tags: [] }; const tNote = db.transaction(['notes'], 'readwrite'); await dbRequest(tNote.objectStore('notes'), 'add', newNote); await tNote.done; }; notePromises.push(noteContentPromise()); } }); await Promise.all(notePromises); showToast('å¯¼å…¥æˆåŠŸï¼', 'success'); await renderUI(); } catch (error) { console.error('å¯¼å…¥å¤±è´¥:', error); showToast('å¯¼å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ã€‚', 'error'); } finally { importZipBtn.disabled = false; importZipBtn.innerHTML = originalBtn; importFileInput.value = ''; } };
            function initTheme() { if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { setTheme('dark'); } else { setTheme('light'); } };
            function setTheme(theme) { const newThemeName = theme === 'dark' ? 'dark' : 'default'; const currentContent = editor ? editor.getMarkdown() : ''; if(theme === 'dark') { htmlRoot.classList.add('dark'); themeIconLight.classList.add('hidden'); themeIconDark.classList.remove('hidden'); } else { htmlRoot.classList.remove('dark'); themeIconLight.classList.remove('hidden'); themeIconDark.classList.add('hidden'); } recreateEditor(newThemeName); if (activeNoteId !== null) { editor.setMarkdown(currentContent); } localStorage.theme = theme; };
            function recreateEditor(theme) { if (editor) { editor.destroy(); } editor = new toastui.Editor({ el: editorContainer, height: '100%', initialEditType: 'wysiwyg', previewStyle: 'vertical', placeholder: 'å¼€å§‹ä¹¦å†™ä½ çš„æƒ³æ³•...', theme: theme }); editor.on('change', updateNoteContent); }
            
            // --- äº‹ä»¶ç›‘å¬å™¨ ---
            modalCancelBtn.addEventListener('click', hideModal);
            confirmationModal.addEventListener('click', (e) => { if (e.target === confirmationModal) hideModal(); });
            window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !confirmationModal.classList.contains('hidden')) hideModal(); });
            confirmationModal.addEventListener('keydown', (e) => { if (e.key === 'Tab') { const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'; const focusableContent = Array.from(confirmationModal.querySelectorAll(focusableElements)); if (focusableContent.length === 0) return; const firstFocusableElement = focusableContent[0]; const lastFocusableElement = focusableContent[focusableContent.length - 1]; if (e.shiftKey) { if (document.activeElement === firstFocusableElement) { lastFocusableElement.focus(); e.preventDefault(); } } else { if (document.activeElement === lastFocusableElement) { firstFocusableElement.focus(); e.preventDefault(); } } } });
            noteList.addEventListener('contextmenu', e => { e.preventDefault(); const targetLi = e.target.closest('li'); if (targetLi) handleDeleteNote(parseInt(targetLi.dataset.noteId)); });
            noteContextMenu.addEventListener('click', e => { const action = e.target.closest('button')?.dataset.action; const noteId = parseInt(noteContextMenu.dataset.noteId); if (action === 'delete' && noteId) handleDeleteNote(noteId); noteContextMenu.classList.add('hidden'); });
            themeToggleBtn.addEventListener('click', () => setTheme(htmlRoot.classList.contains('dark') ? 'light' : 'dark'));
            importZipBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (e) => importNotesFromZip(e.target.files[0]));
            tagInput.addEventListener('keydown', async (e) => { if (e.key === 'Enter' && activeNoteId !== null) { e.preventDefault(); const newTag = tagInput.value.trim(); if (newTag) { const note = await getById('notes', activeNoteId); const currentTags = note.tags || []; if (!currentTags.includes(newTag)) { const updatedTags = [...currentTags, newTag]; await updateNoteTags(updatedTags); renderTagsUI(updatedTags); } tagInput.value = ''; } } });
            tagsContainer.addEventListener('click', async (e) => { const removeBtn = e.target.closest('.tag-remove-btn'); if (removeBtn && activeNoteId !== null) { const tagToRemove = removeBtn.dataset.tagName; const note = await getById('notes', activeNoteId); const updatedTags = (note.tags || []).filter(t => t !== tagToRemove); await updateNoteTags(updatedTags); renderTagsUI(updatedTags); } });
            searchInput.addEventListener('input', () => { clearTimeout(debounceTimeout); debounceTimeout = setTimeout(() => { currentSearchQuery = searchInput.value.trim(); activeNoteId = null; editorContainer.classList.add('hidden'); editorPlaceholder.style.display = 'flex'; deleteNoteBtn.style.display = 'none'; noteFolderSelector.classList.add('hidden'); tagsArea.classList.add('hidden'); renderUI(); }, 250); });
            noteFolderSelector.addEventListener('change', moveNoteToFolder);
            newFolderBtn.addEventListener('click', createFolder);
            newNoteBtn.addEventListener('click', createNote);
            deleteNoteBtn.addEventListener('click', () => handleDeleteNote(activeNoteId));
            exportAllBtn.addEventListener('click', exportAllNotesAsZip);
            folderList.addEventListener('click', e => { const targetLi = e.target.closest('li'); if (!targetLi) return; const folderIdStr = targetLi.dataset.folderId; const folderId = isNaN(parseInt(folderIdStr)) ? folderIdStr : parseInt(folderIdStr); if (e.target.closest('.delete-folder-btn')) deleteFolder(folderId); else selectFolder(folderId); });
            noteList.addEventListener('click', e => { const targetLi = e.target.closest('li'); if (targetLi) selectNote(parseInt(targetLi.dataset.noteId)); });
            window.addEventListener('click', (e) => { if (!noteContextMenu.contains(e.target)) { noteContextMenu.classList.add('hidden'); } });
            menuToggleBtn.addEventListener('click', (e) => { e.stopPropagation(); const isExpanded = sidebar.classList.toggle('-translate-x-full'); menuToggleBtn.setAttribute('aria-expanded', !isExpanded); });
            if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js').then(reg => console.log('SW registered.'), err => console.log('SW registration failed: ', err)); }); }
            deleteNoteBtn.style.display = 'none';
            noteFolderSelector.classList.add('hidden');
            tagsArea.classList.add('hidden');
        });
    </script>
</body>
</html>